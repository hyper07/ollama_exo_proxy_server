{% extends "admin/base.html" %}

{% block title %}EXO API Tester - {{ super() }}{% endblock %}

{% block header_title %}EXO Master API Tester{% endblock %}

{% block content %}
<style>
    .api-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    
    .api-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .method-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.875rem;
        margin-right: 0.5rem;
    }
    
    .method-get {
        background-color: #10b981;
        color: white;
    }
    
    .method-post {
        background-color: #3b82f6;
        color: white;
    }
    
    .method-delete {
        background-color: #ef4444;
        color: white;
    }
    
    .response-box {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.375rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    
    .form-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        background-color: rgba(255, 255, 255, 0.05);
        color: inherit;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .btn-test {
        background-color: var(--color-primary-600);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .btn-test:hover {
        background-color: var(--color-primary-700);
        transform: translateY(-1px);
    }
    
    .btn-test:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .loading {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="mb-6">
    <p class="text-sm opacity-80 mb-4">Test the EXO Master API endpoints directly. This interface makes direct calls to your EXO instance (no proxy layer). Configure your EXO instance URL below.</p>
    
    <div class="p-4 bg-green-900/20 border border-green-500/50 rounded mb-4">
        <h4 class="font-semibold mb-2">ðŸš€ Quick Start Guide</h4>
        <ol class="text-sm space-y-1 ml-4">
            <li>1. Set your EXO Base URL (e.g., <code class="bg-gray-700 px-1">http://localhost:52415</code>)</li>
            <li>2. Test <strong>GET /models</strong> to see available models</li>
            <li>3. Use <strong>POST /place_instance</strong> with a model short ID (e.g., <code class="bg-gray-700 px-1">llama-3.2-1b-instruct</code>)</li>
            <li>4. Test <strong>GET /state</strong> to get the full model ID from running instances</li>
            <li>5. Use <strong>POST /v1/chat/completions</strong> with the full model ID to chat</li>
        </ol>
    </div>
    
    <div class="grid grid-cols-1 gap-4 mb-6 card-style p-4">
        <div>
            <label class="form-label">EXO Base URL</label>
            <input type="text" id="base-url" class="form-input" value="http://localhost:52415" placeholder="http://192.168.1.188:52415">
            <p class="text-xs opacity-60 mt-1">
                <strong>Format:</strong> http://[host]:[port] (no trailing slash)
                <br>
                <strong>Default Port:</strong> 52415 (EXO's default API port)
                <br>
                <strong>Examples:</strong> 
                <span class="cursor-pointer hover:underline text-blue-400" onclick="document.getElementById('base-url').value='http://localhost:52415'">http://localhost:52415</span> | 
                <span class="cursor-pointer hover:underline text-blue-400" onclick="document.getElementById('base-url').value='http://192.168.1.188:52415'">http://192.168.1.188:52415</span>
            </p>
        </div>
        
        <div>
            <label class="form-label">EXO API Key (Optional)</label>
            <input type="password" id="api-key" class="form-input" placeholder="Leave empty if no auth required">
            <p class="text-xs opacity-60 mt-1">
                <strong>Optional:</strong> Only needed if your EXO instance requires authentication.
                <br>
                By default, EXO runs without authentication. If set, will be sent as: <code class="text-xs bg-gray-700 px-1 py-0.5 rounded">Authorization: Bearer YOUR_KEY</code>
            </p>
        </div>
    </div>
</div>

<!-- GET /node_id -->
<div class="api-section card-style">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold">
                <span class="method-badge method-get">GET</span>
                <span class="font-mono">/node_id</span>
            </h3>
            <p class="text-sm opacity-70 mt-1">Get the current node ID</p>
        </div>
        <button onclick="testNodeId()" class="btn-test">Test</button>
    </div>
    <div id="response-node-id" class="response-box hidden"></div>
</div>

<!-- GET /models -->
<div class="api-section card-style">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold">
                <span class="method-badge method-get">GET</span>
                <span class="font-mono">/models</span>
            </h3>
            <p class="text-sm opacity-70 mt-1">List all available models</p>
        </div>
        <button onclick="testModels()" class="btn-test">Test</button>
    </div>
    <div id="response-models" class="response-box hidden"></div>
</div>

<!-- GET /state -->
<div class="api-section card-style">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold">
                <span class="method-badge method-get">GET</span>
                <span class="font-mono">/state</span>
            </h3>
            <p class="text-sm opacity-70 mt-1">Get the current state of the EXO cluster</p>
        </div>
        <button onclick="testState()" class="btn-test">Test</button>
    </div>
    <div id="response-state" class="response-box hidden"></div>
</div>

<!-- GET /events -->
<div class="api-section card-style">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold">
                <span class="method-badge method-get">GET</span>
                <span class="font-mono">/events</span>
            </h3>
            <p class="text-sm opacity-70 mt-1">Get the event log</p>
        </div>
        <button onclick="testEvents()" class="btn-test">Test</button>
    </div>
    <div id="response-events" class="response-box hidden"></div>
</div>

<!-- GET /instance/placement -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-get">GET</span>
            <span class="font-mono">/instance/placement</span>
        </h3>
        <p class="text-sm opacity-70">Get placement for a model instance</p>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="form-label">Model ID</label>
            <input type="text" id="placement-model-id" class="form-input" placeholder="llama-3.2-1b-instruct">
        </div>
        <div>
            <label class="form-label">Sharding</label>
            <select id="placement-sharding" class="form-input">
                <option value="Pipeline">Pipeline</option>
                <option value="Ring">Ring</option>
            </select>
        </div>
        <div>
            <label class="form-label">Instance Meta</label>
            <select id="placement-instance-meta" class="form-input">
                <option value="MlxRing">MlxRing</option>
                <option value="MlxPipeline">MlxPipeline</option>
            </select>
        </div>
        <div>
            <label class="form-label">Min Nodes</label>
            <input type="number" id="placement-min-nodes" class="form-input" value="1" min="1">
        </div>
    </div>
    
    <button onclick="testPlacement()" class="btn-test">Test Placement</button>
    <div id="response-placement" class="response-box hidden"></div>
</div>

<!-- GET /instance/previews -->
<div class="api-section card-style">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold">
                <span class="method-badge method-get">GET</span>
                <span class="font-mono">/instance/previews</span>
            </h3>
            <p class="text-sm opacity-70 mt-1">Get placement previews for all compatible models</p>
        </div>
        <button onclick="testPlacementPreviews()" class="btn-test">Test</button>
    </div>
    <div id="response-placement-previews" class="response-box hidden"></div>
</div>

<!-- POST /instance -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-post">POST</span>
            <span class="font-mono">/instance</span>
        </h3>
        <p class="text-sm opacity-70">Create a new instance</p>
    </div>
    
    <div class="mb-4">
        <label class="form-label">Instance JSON</label>
        <textarea id="create-instance-json" class="form-input" rows="10" placeholder='{"instance_id": "...", "model": {...}, ...}'></textarea>
        <p class="text-xs opacity-60 mt-1">Enter the complete instance object in JSON format</p>
    </div>
    
    <button onclick="testCreateInstance()" class="btn-test">Create Instance</button>
    <div id="response-create-instance" class="response-box hidden"></div>
</div>

<!-- POST /place_instance -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-post">POST</span>
            <span class="font-mono">/place_instance</span>
        </h3>
        <p class="text-sm opacity-70">Place an instance with automatic placement</p>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="form-label">Model ID</label>
            <input type="text" id="place-model-id" class="form-input" placeholder="llama-3.2-1b-instruct">
        </div>
        <div>
            <label class="form-label">Sharding</label>
            <select id="place-sharding" class="form-input">
                <option value="Pipeline">Pipeline</option>
                <option value="Ring">Ring</option>
            </select>
        </div>
        <div>
            <label class="form-label">Instance Meta</label>
            <select id="place-instance-meta" class="form-input">
                <option value="MlxRing">MlxRing</option>
                <option value="MlxPipeline">MlxPipeline</option>
            </select>
        </div>
        <div>
            <label class="form-label">Min Nodes</label>
            <input type="number" id="place-min-nodes" class="form-input" value="1" min="1">
        </div>
    </div>
    
    <button onclick="testPlaceInstance()" class="btn-test">Place Instance</button>
    <div id="response-place-instance" class="response-box hidden"></div>
</div>

<!-- GET /instance/{instance_id} -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-get">GET</span>
            <span class="font-mono">/instance/{'{instance_id}'}</span>
        </h3>
        <p class="text-sm opacity-70">Get details of a specific instance</p>
    </div>
    
    <div class="mb-4">
        <label class="form-label">Instance ID</label>
        <input type="text" id="get-instance-id" class="form-input" placeholder="Enter instance ID">
    </div>
    
    <button onclick="testGetInstance()" class="btn-test">Get Instance</button>
    <div id="response-get-instance" class="response-box hidden"></div>
</div>

<!-- DELETE /instance/{instance_id} -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-delete">DELETE</span>
            <span class="font-mono">/instance/{'{instance_id}'}</span>
        </h3>
        <p class="text-sm opacity-70">Delete a specific instance</p>
    </div>
    
    <div class="mb-4">
        <label class="form-label">Instance ID</label>
        <input type="text" id="delete-instance-id" class="form-input" placeholder="Enter instance ID">
    </div>
    
    <button onclick="testDeleteInstance()" class="btn-test">Delete Instance</button>
    <div id="response-delete-instance" class="response-box hidden"></div>
</div>

<!-- POST /v1/chat/completions -->
<div class="api-section card-style">
    <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">
            <span class="method-badge method-post">POST</span>
            <span class="font-mono">/v1/chat/completions</span>
        </h3>
        <p class="text-sm opacity-70">Send a chat completion request (OpenAI-compatible)</p>
        

        
        <div class="mt-3 p-3 bg-purple-900/30 border border-purple-500/50 rounded text-sm">
            <strong>ðŸ“¡ Streaming vs Non-Streaming:</strong>
            <div class="ml-4 mt-2 space-y-2">
                <div>
                    <strong>Stream = true:</strong> Returns Server-Sent Events (SSE) format
                    <pre class="text-xs bg-gray-800 p-2 mt-1 rounded overflow-x-auto">data: {"id":"...","choices":[{"delta":{"content":"Hello"}}]}\ndata: {"id":"...","choices":[{"delta":{"content":"!"}}]}\ndata: [DONE]</pre>
                    <p class="text-xs mt-1 opacity-80">âœ“ Real-time streaming response â€¢ âœ“ See tokens as generated â€¢ âœ“ Better UX for long responses</p>
                </div>
                <div>
                    <strong>Stream = false:</strong> Returns single JSON object
                    <pre class="text-xs bg-gray-800 p-2 mt-1 rounded overflow-x-auto">{"id":"...","choices":[{"message":{"content":"Hello!"}}],"usage":{...}}</pre>
                    <p class="text-xs mt-1 opacity-80">âœ“ Complete response at once â€¢ âœ“ Includes token usage stats â€¢ âœ“ OpenAI-compatible format</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
            <label class="form-label">Model (Use FULL model ID from /state)</label>
            <input type="text" id="chat-model" class="form-input" placeholder="mlx-community/Llama-3.2-1B-Instruct-4bit">
            <p class="text-xs opacity-60 mt-1">
                <strong>Important:</strong> Use the full model ID (e.g., <code class="bg-gray-700 px-1 py-0.5 rounded">mlx-community/Llama-3.2-1B-Instruct-4bit</code>) NOT the short ID (<code class="bg-gray-700 px-1 py-0.5 rounded line-through">llama-3.2-1b-instruct</code>).
                <br>Get this from <strong>GET /state</strong> â†’ <code class="bg-gray-700 px-1 py-0.5 rounded">instances[...].shardAssignments.modelId</code>
            </p>
        </div>
        <div>
            <label class="form-label">Messages (JSON Array)</label>
            <textarea id="chat-messages" class="form-input" rows="6" placeholder='[{"role": "user", "content": "Hello!"}]'>[{"role": "user", "content": "Hello! How are you?"}]</textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="form-label">Temperature</label>
                <input type="number" id="chat-temperature" class="form-input" value="0.7" step="0.1" min="0" max="2">
            </div>
            <div>
                <label class="form-label">Max Tokens</label>
                <input type="number" id="chat-max-tokens" class="form-input" value="100" min="1">
            </div>
        </div>
        <div>
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="chat-stream" class="mr-2 w-4 h-4 cursor-pointer">
                <span class="form-label mb-0">Enable Streaming (SSE)</span>
            </label>
            <p class="text-xs opacity-60 mt-1 ml-6">
                <strong>Checked:</strong> Receive tokens in real-time via Server-Sent Events (streaming)
                <br>
                <strong>Unchecked:</strong> Receive complete response as single JSON object
            </p>
        </div>
    </div>
    
    <div class="flex gap-3 mb-4">
        <button onclick="testChatCompletion()" class="btn-test" id="chat-send-btn">
            <span id="btn-icon">ðŸ“¤</span> Send Chat Request
        </button>
    </div>
    <div id="response-check-model" class="response-box hidden"></div>
    <div id="response-chat" class="response-box hidden"></div>
</div>

<!-- Hidden CSRF token for form submissions -->
<input type="hidden" name="csrf_token" value="{{ csrf_token }}">

<script src="{{ url_for('admin_api_tester_script') }}"></script>

{% endblock %}

