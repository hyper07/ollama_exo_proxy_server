{% extends "admin/base.html" %}

{% block title %}{{ knowledge_base.name }}{% endblock %}

{% block header_title %}Knowledge Base: {{ knowledge_base.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-start">
        <a href="{{ url_for('admin_knowledge_bases') }}" class="text-[var(--color-primary-500)] hover:underline">&larr; Back to Knowledge Bases</a>
    </div>

    <!-- Knowledge Base Info -->
    <div class="card-style">
        <h3 class="text-lg font-bold mb-4">Details</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <span class="text-gray-400">Description:</span>
                <p class="text-current">{{ knowledge_base.description or "No description" }}</p>
            </div>
            <div>
                <span class="text-gray-400">Embedding Model:</span>
                <p class="text-current font-mono">{{ knowledge_base.embedding_model }}</p>
            </div>
            <div>
                <span class="text-gray-400">Chunk Size:</span>
                <p class="text-current">{{ knowledge_base.chunk_size }} characters</p>
            </div>
            <div>
                <span class="text-gray-400">Chunk Overlap:</span>
                <p class="text-current">{{ knowledge_base.chunk_overlap }} characters</p>
            </div>
        </div>
    </div>

    <!-- Upload Document -->
    <div class="card-style">
        <h3 class="text-lg font-bold mb-4">Upload Document</h3>
        <form id="uploadForm" onsubmit="uploadDocument(event)" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="file" accept=".txt,.md,.json,.csv,.py,.js,.html,.css,.xml,.yaml,.yml,.log" required class="mb-4">
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary-600)] hover:bg-[var(--color-primary-700)] rounded-md text-white">
                Upload & Index
            </button>
        </form>
        <div id="uploadStatus" class="mt-4 hidden"></div>
    </div>

    <!-- Documents List -->
    <div class="card-style">
        <h3 class="text-lg font-bold mb-4">Documents ({{ documents|length }})</h3>
        {% if documents %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Filename</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Chunks</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for doc in documents %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ doc.filename }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ doc.file_type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ (doc.file_size / 1024)|round(2) }} KB</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ doc.chunk_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full {{ 'bg-green-500/20 text-green-300' if doc.is_indexed else 'bg-yellow-500/20 text-yellow-300' }}">
                                {{ 'Indexed' if doc.is_indexed else 'Pending' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="deleteDocument('{{ doc.id }}')" class="text-red-400 hover:underline">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-400 text-center py-8">No documents uploaded yet.</p>
        {% endif %}
    </div>

    <!-- Test Search -->
    <div class="card-style">
        <h3 class="text-lg font-bold mb-4">Test Search</h3>
        <form onsubmit="testSearch(event)" class="flex gap-2">
            <input type="text" id="searchQuery" placeholder="Enter search query..." required class="flex-grow px-3 py-2 rounded-md bg-white/10 border border-white/20">
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary-600)] hover:bg-[var(--color-primary-700)] rounded-md text-white">
                Search
            </button>
        </form>
        <div id="searchResults" class="mt-4 hidden"></div>
    </div>
</div>

<script>
async function uploadDocument(e) {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('fileInput');
    formData.append('file', fileInput.files[0]);
    
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.classList.remove('hidden');
    statusDiv.innerHTML = '<p class="text-yellow-400">Uploading and indexing...</p>';
    
    try {
        const response = await fetch("{{ url_for('admin_upload_document', kb_id=knowledge_base.id) }}", {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            statusDiv.innerHTML = `<p class="text-green-400">${result.message}</p>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<p class="text-red-400">Error: ${result.error}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
    }
}

async function testSearch(e) {
    e.preventDefault();
    const query = document.getElementById('searchQuery').value;
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.classList.remove('hidden');
    resultsDiv.innerHTML = '<p class="text-yellow-400">Searching...</p>';
    
    try {
        const formData = new URLSearchParams();
        formData.append('query', query);
        formData.append('top_k', '5');
        
        const response = await fetch("{{ url_for('admin_search_knowledge_base', kb_id=knowledge_base.id) }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            let html = `<p class="text-green-400 mb-2">Found ${result.count} relevant chunks:</p>`;
            result.chunks.forEach((chunk, i) => {
                html += `<div class="mt-4 p-4 bg-white/5 rounded border border-white/10">`;
                html += `<p class="text-xs text-gray-400 mb-2">From: ${chunk.metadata.document_name} (Chunk ${chunk.metadata.chunk_index})</p>`;
                html += `<p class="text-sm">${chunk.content}</p>`;
                html += `</div>`;
            });
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<p class="text-red-400">Error: ${result.error}</p>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
    }
}

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) return;
    
    try {
        const response = await fetch(`/admin/documents/${docId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}

